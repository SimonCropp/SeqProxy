<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /readme.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# <img src="/src/icon.png" height="30px"> SeqProxy

[![Build status](https://ci.appveyor.com/api/projects/status/7996jd4uoooy5qy2/branch/master?svg=true)](https://ci.appveyor.com/project/SimonCropp/SeqProxy)
[![NuGet Status](https://img.shields.io/nuget/v/SeqProxy.svg)](https://www.nuget.org/packages/SeqProxy/)

Enables writing seq logs by proxying requests through an ASP.NET Controller or Middleware.

Support is available via a [Tidelift Subscription](https://tidelift.com/subscription/pkg/nuget-seqproxy?utm_source=nuget-seqproxy&utm_medium=referral&utm_campaign=enterprise).


## Why

 * Avoid exposing the Seq API to the internet.
 * Leverage [Asp Authentication and Authorization](https://docs.microsoft.com/en-us/aspnet/core/security/) to verify and control incoming requests.
 * Append [extra data](#extra-data) to log messages during server processing.

<!-- toc -->
## Contents

  * [HTTP Format/Protocol](#http-formatprotocol)
  * [Extra data](#extra-data)
  * [Usage](#usage)
    * [Enable in Startup](#enable-in-startup)
    * [Add HTTP handling](#add-http-handling)
  * [Client Side Usage](#client-side-usage)
    * [Using raw JavaScript](#using-raw-javascript)
    * [Using Structured-Log](#using-structured-log)
  * [Security contact information](#security-contact-information)<!-- endtoc -->


## NuGet package

https://nuget.org/packages/SeqProxy/


## HTTP Format/Protocol

Format: [Serilog compact](https://github.com/serilog/serilog-formatting-compact).

Protocol: [Seq raw events](https://docs.datalust.co/docs/posting-raw-events).

Note that timestamp (`@t`) is optional when using this project. If it is not supplied the server timestamp will be used.


## Extra data

For every log entry written the following information is appended:

 * The current application name (as `Application`) defined in code at startup.
 * The current application version (as `ApplicationVersion`) defined in code at startup.
 * The server name (as `Server`) using `Environment.MachineName`.
 * All claims for the current User from `ControllerBase.User.Claims`.
 * The [user-agent header](https://en.wikipedia.org/wiki/User_agent) as `UserAgent`.
 * The [referer header](https://en.wikipedia.org/wiki/HTTP_referer) as `Referrer`.

<img src="/src/extraData.png">


## Usage


### Enable in Startup

Enable in `Startup.ConfigureServices`

<!-- snippet: ConfigureServices -->
<a id='snippet-configureservices'/></a>
```cs
public void ConfigureServices(IServiceCollection services)
{
    services.AddMvcCore(option => option.EnableEndpointRouting = false);
    services.AddSeqWriter(seqUrl: "http://localhost:5341");
}
```
<sup><a href='/src/SampleWeb/Startup.cs#L14-L22' title='File snippet `configureservices` was extracted from'>snippet source</a> | <a href='#snippet-configureservices' title='Navigate to start of snippet `configureservices`'>anchor</a></sup>
<!-- endsnippet -->

There are several optional parameters:

<!-- snippet: ConfigureServicesFull -->
<a id='snippet-configureservicesfull'/></a>
```cs
public void ConfigureServices(IServiceCollection services)
{
    services.AddMvcCore();
    services.AddSeqWriter(
        seqUrl: "http://localhost:5341",
        apiKey: "TheApiKey",
        application: "MyAppName",
        appVersion: new Version(1, 2),
        scrubClaimType: claimType => claimType.Split("/").Last());
}
```
<sup><a href='/src/Tests/FullStartupConfig.cs#L7-L20' title='File snippet `configureservicesfull` was extracted from'>snippet source</a> | <a href='#snippet-configureservicesfull' title='Navigate to start of snippet `configureservicesfull`'>anchor</a></sup>
<!-- endsnippet -->

 * `application` defaults to `Assembly.GetCallingAssembly().GetName().Name`.
 * `applicationVersion` defaults to `Assembly.GetCallingAssembly().GetName().Version`.
 * `scrubClaimType` is used to clean up claimtype strings. For example [ClaimTypes.Email](https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.claims.claimtypes.email?System_IdentityModel_Claims_ClaimTypes_Email) is `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`, but when recording to Seq the value `emailaddress` is sufficient. Defaults to `DefaultClaimTypeScrubber.Scrub` to get the string after the last `/`.

<!-- snippet: DefaultClaimTypeScrubber.cs -->
<a id='snippet-DefaultClaimTypeScrubber.cs'/></a>
```cs
namespace SeqProxy
{
    /// <summary>
    /// Used for scrubbing claims when no other scrubber is defined.
    /// </summary>
    public static class DefaultClaimTypeScrubber
    {
        /// <summary>
        /// Get the string after the last /.
        /// </summary>
        public static string Scrub(string claimType)
        {
            Guard.AgainstNullOrEmpty(claimType, nameof(claimType));
            var lastIndexOf = claimType.LastIndexOf("/");
            if (lastIndexOf == -1)
            {
                return claimType;
            }

            return claimType.Substring(lastIndexOf + 1);
        }
    }
}
```
<sup><a href='/src/SeqProxy/DefaultClaimTypeScrubber.cs#L1-L23' title='File snippet `DefaultClaimTypeScrubber.cs` was extracted from'>snippet source</a> | <a href='#snippet-DefaultClaimTypeScrubber.cs' title='Navigate to start of snippet `DefaultClaimTypeScrubber.cs`'>anchor</a></sup>
<!-- endsnippet -->


### Add HTTP handling

There are two approaches to handling the HTTP containing log events. Using a Middleware and using a Controller.


#### Using a Middleware

Using a [Middleware](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/) is done by calling `SeqWriterConfig.UseSeq` in `Startup.Configure(IApplicationBuilder builder)`:

<!-- snippet: ConfigureBuilder -->
<a id='snippet-configurebuilder'/></a>
```cs
public void Configure(IApplicationBuilder builder)
{
    builder.UseSeq();
```
<sup><a href='/src/SampleWeb/Startup.cs#L24-L29' title='File snippet `configurebuilder` was extracted from'>snippet source</a> | <a href='#snippet-configurebuilder' title='Navigate to start of snippet `configurebuilder`'>anchor</a></sup>
<!-- endsnippet -->


##### Authorization

Authorization in the middleware can bu done by using `useAuthorizationService = true` in `UseSeq`.

<!-- snippet: StartupWithAuth -->
<a id='snippet-startupwithauth'/></a>
```cs
public void Configure(IApplicationBuilder builder)
{
    builder.UseSeq(useAuthorizationService: true);
```
<sup><a href='/src/Tests/StartupWithAuth.cs#L6-L11' title='File snippet `startupwithauth` was extracted from'>snippet source</a> | <a href='#snippet-startupwithauth' title='Navigate to start of snippet `startupwithauth`'>anchor</a></sup>
<!-- endsnippet -->

This then uses [IAuthorizationService](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/resourcebased) to verify the request:

<!-- snippet: HandleWithAuth -->
<a id='snippet-handlewithauth'/></a>
```cs
async Task HandleWithAuth(
    HttpContext context,
    IAuthorizationService authService)
{
    var user = context.User;
    var authResult = await authService.AuthorizeAsync(user, null, "SeqLog");

    if (!authResult.Succeeded)
    {
        await context.ChallengeAsync();
        return;
    }

    await seqWriter.Handle(
        user,
        context.Request,
        context.Response,
        context.RequestAborted);
}
```
<sup><a href='/src/SeqProxy/SeqMiddlewareWithAuth.cs#L37-L59' title='File snippet `handlewithauth` was extracted from'>snippet source</a> | <a href='#snippet-handlewithauth' title='Navigate to start of snippet `handlewithauth`'>anchor</a></sup>
<!-- endsnippet -->


#### Using a Controller

`BaseSeqController` is an implementation of `ControllerBase` that provides a HTTP post and some basic routing.

<!-- snippet: BaseSeqController.cs -->
<a id='snippet-BaseSeqController.cs'/></a>
```cs
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

namespace SeqProxy
{
    /// <summary>
    /// An implementation of <see cref="ControllerBase"/> that provides a http post and some basic routing.
    /// </summary>
    [Route("/api/events/raw")]
    [Route("/seq")]
    [ApiController]
    public abstract class BaseSeqController :
        ControllerBase
    {
        SeqWriter seqWriter;

        /// <summary>
        /// Initializes a new instance of <see cref="BaseSeqController"/>
        /// </summary>
        protected BaseSeqController(SeqWriter seqWriter)
        {
            Guard.AgainstNull(seqWriter, nameof(seqWriter));
            this.seqWriter = seqWriter;
        }

        /// <summary>
        /// Handles log events via a HTTP post.
        /// </summary>
        [HttpPost]
        public virtual Task Post()
        {
            return seqWriter.Handle(User, Request, Response, HttpContext.RequestAborted);
        }
    }
}
```
<sup><a href='/src/SeqProxy/BaseSeqController.cs#L1-L35' title='File snippet `BaseSeqController.cs` was extracted from'>snippet source</a> | <a href='#snippet-BaseSeqController.cs' title='Navigate to start of snippet `BaseSeqController.cs`'>anchor</a></sup>
<!-- endsnippet -->

Add a new [controller](https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/actions) that overrides `BaseSeqController`.

<!-- snippet: SimpleController -->
<a id='snippet-simplecontroller'/></a>
```cs
public class SeqController :
    BaseSeqController
{
    public SeqController(SeqWriter seqWriter) :
        base(seqWriter)
    {
    }
}
```
<sup><a href='/src/Tests/ControllerSamples.cs#L8-L17' title='File snippet `simplecontroller` was extracted from'>snippet source</a> | <a href='#snippet-simplecontroller' title='Navigate to start of snippet `simplecontroller`'>anchor</a></sup>
<!-- endsnippet -->


##### Authorization/Authentication

Adding authorization and authentication can be done with an [AuthorizeAttribute](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/simple).

<!-- snippet: AuthorizeController -->
<a id='snippet-authorizecontroller'/></a>
```cs
[Authorize]
public class SeqController :
    BaseSeqController
```
<sup><a href='/src/Tests/ControllerSamples.cs#L46-L50' title='File snippet `authorizecontroller` was extracted from'>snippet source</a> | <a href='#snippet-authorizecontroller' title='Navigate to start of snippet `authorizecontroller`'>anchor</a></sup>
<!-- endsnippet -->


##### Method level attributes

Method level Asp attributes can by applied by overriding `BaseSeqController.Post`.

For example adding an [exception filter ](https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/filters#exception-filters).

<!-- snippet: OverridePostController -->
<a id='snippet-overridepostcontroller'/></a>
```cs
public class SeqController :
    BaseSeqController
{
    [CustomExceptionFilter]
    public override Task Post()
    {
        return base.Post();
    }
```
<sup><a href='/src/Tests/ControllerSamples.cs#L22-L31' title='File snippet `overridepostcontroller` was extracted from'>snippet source</a> | <a href='#snippet-overridepostcontroller' title='Navigate to start of snippet `overridepostcontroller`'>anchor</a></sup>
<!-- endsnippet -->


## Client Side Usage


### Using raw JavaScript

Writing to Seq can be done using a HTTP post:

<!-- snippet: LogRawJs -->
<a id='snippet-lograwjs'/></a>
```js
function LogRawJs(text) {
    const postSettings = {
        method: 'POST',
        credentials: 'include',
        body: `{'@mt':'RawJs input: {Text}','Text':'${text}'}`
    };

    return fetch('/api/events/raw', postSettings);
}
```
<sup><a href='/src/SampleWeb/sample.js#L59-L69' title='File snippet `lograwjs` was extracted from'>snippet source</a> | <a href='#snippet-lograwjs' title='Navigate to start of snippet `lograwjs`'>anchor</a></sup>
<!-- endsnippet -->


### Using Structured-Log

[structured-log](https://github.com/structured-log/structured-log/) is a structured logging framework for JavaScript, inspired by Serilog.

In combination with [structured-log-seq-sink](https://github.com/Wedvich/structured-log-seq-sink) it can be used to write to Seq

To use this approach:


#### Include the libraries

Install both [structured-log npm](https://www.npmjs.com/package/structured-log) and [structured-log-seq-sink npm](https://www.npmjs.com/package/structured-log-seq-sink). Or include them from [jsDelivr](https://www.jsdelivr.com/):

<!-- snippet: StructuredLogInclude -->
<a id='snippet-structuredloginclude'/></a>
```html
<script src='https://cdn.jsdelivr.net/npm/structured-log/dist/structured-log.js'>
</script>
<script src='https://cdn.jsdelivr.net/npm/structured-log-seq-sink/dist/structured-log-seq-sink.js'>
</script>
```
<sup><a href='/src/SampleWeb/sample.html#L4-L9' title='File snippet `structuredloginclude` was extracted from'>snippet source</a> | <a href='#snippet-structuredloginclude' title='Navigate to start of snippet `structuredloginclude`'>anchor</a></sup>
<!-- endsnippet -->


#### Configure the log

<!-- snippet: StructuredLogConfig -->
<a id='snippet-structuredlogconfig'/></a>
```js
var levelSwitch = new structuredLog.DynamicLevelSwitch('info');
const log = structuredLog.configure()
    .writeTo(new structuredLog.ConsoleSink())
    .minLevel(levelSwitch)
    .writeTo(SeqSink({
        url: `${location.protocol}//${location.host}`,
        compact: true,
        levelSwitch: levelSwitch
    }))
    .create();
```
<sup><a href='/src/SampleWeb/sample.js#L1-L12' title='File snippet `structuredlogconfig` was extracted from'>snippet source</a> | <a href='#snippet-structuredlogconfig' title='Navigate to start of snippet `structuredlogconfig`'>anchor</a></sup>
<!-- endsnippet -->


#### Write a log message

<!-- snippet: StructuredLog -->
<a id='snippet-structuredlog'/></a>
```js
function LogStructured(text) {
    log.info('StructuredLog input: {Text}', text);
}
```
<sup><a href='/src/SampleWeb/sample.js#L50-L54' title='File snippet `structuredlog` was extracted from'>snippet source</a> | <a href='#snippet-structuredlog' title='Navigate to start of snippet `structuredlog`'>anchor</a></sup>
<!-- endsnippet -->


#### Including data but omitting from the message template

When using structured-log, data not included in the message template will be named with a convention of `a+counter`. So for example if the following is logged:

```
log.info('The text: {Text}', text, "OtherData");
```

Then `OtherData` would be written to Seq with the property name `a1`.

To work around this:

Include a filter that replaces a known token name (in this case `{@Properties}`):

<!-- snippet: StructuredLogConfigExtraProp -->
<a id='snippet-structuredlogconfigextraprop'/></a>
```js
const logWithExtraProps = structuredLog.configure()
    .filter(logEvent => {
        const template = logEvent.messageTemplate;
        template.raw = template.raw.replace('{@Properties}','');
        return true;
    })
    .writeTo(SeqSink({
        url: `${location.protocol}//${location.host}`,
        compact: true,
        levelSwitch: levelSwitch
    }))
    .create();
```
<sup><a href='/src/SampleWeb/sample.js#L14-L27' title='File snippet `structuredlogconfigextraprop` was extracted from'>snippet source</a> | <a href='#snippet-structuredlogconfigextraprop' title='Navigate to start of snippet `structuredlogconfigextraprop`'>anchor</a></sup>
<!-- endsnippet -->

Include that token name in the message template, and then include an object at the same position in the log parameters:

<!-- snippet: StructuredLogWithExtraProps -->
<a id='snippet-structuredlogwithextraprops'/></a>
```js
function LogStructuredWithExtraProps(text) {
    logWithExtraProps.info(
        'StructuredLog input: {Text} {@Properties}',
        text,
        {
            Timezone: new Date().getTimezoneOffset(),
            Language: navigator.language
        });
}
```
<sup><a href='/src/SampleWeb/sample.js#L38-L48' title='File snippet `structuredlogwithextraprops` was extracted from'>snippet source</a> | <a href='#snippet-structuredlogwithextraprops' title='Navigate to start of snippet `structuredlogwithextraprops`'>anchor</a></sup>
<!-- endsnippet -->

Then a destructured property will be written to Seq.

<img src="/src/omitFromMessage.png">


## Security contact information

To report a security vulnerability, use the [Tidelift security contact](https://tidelift.com/security). Tidelift will coordinate the fix and disclosure.


## Icon

[Robot](https://thenounproject.com/term/robot/883226/) designed by [Maxim Kulikov](https://thenounproject.com/maxim221) from [The Noun Project](https://thenounproject.com).
